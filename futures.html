<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures - BitSafe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-time.active { background-color: #FCD535; color: #000; border-color: #FCD535; }
        .bottom-nav-item.active { color: #1f2937; }
        .bottom-nav-item { color: #9ca3af; }
    </style>
</head>
<body class="bg-white text-gray-800 pb-24">

    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-white sticky top-0 z-40 border-b border-gray-100">
        <i class="fa-solid fa-chevron-left text-xl text-gray-600" onclick="location.href='quotes.html'"></i>
        <div class="flex flex-col items-center">
            <h1 class="font-bold text-lg" id="pairTitle">BTC/USDT</h1>
        </div>
        <i class="fa-solid fa-clock-rotate-left text-xl text-gray-600"></i>
    </div>

    <!-- Chart Area -->
    <div id="tv_chart_container" class="w-full h-[350px] bg-gray-50"></div>

    <!-- Trading Section -->
    <div class="px-4 py-4 rounded-t-3xl bg-white -mt-4 relative z-10 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        
        <!-- Time Selection -->
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-medium text-gray-400">Settlement Time</span>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-6">
            <button onclick="selectTime(30)" id="t30" class="btn-time active py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-600 transition-all">30s</button>
            <button onclick="selectTime(60)" id="t60" class="btn-time py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-600 transition-all">60s</button>
            <button onclick="selectTime(180)" id="t180" class="btn-time py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-600 transition-all">180s</button>
            <button onclick="selectTime(300)" id="t300" class="btn-time py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-600 transition-all">300s</button>
        </div>

        <!-- Amount Input -->
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-medium text-gray-400">Invest Amount</span>
            <span class="text-xs font-medium text-gray-400">Bal: <span id="userBalance">0.00</span></span>
        </div>
        <div class="flex items-center bg-gray-100 rounded-xl px-4 py-3 mb-6">
            <input type="number" id="amount" class="bg-transparent w-full text-lg font-bold outline-none text-gray-800 placeholder-gray-300" placeholder="Minimum 10">
            <span class="text-sm font-semibold text-gray-500">USDT</span>
        </div>

        <!-- Profit Info -->
        <div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
            <span class="text-sm text-gray-500">Expected Profit</span>
            <span class="text-lg font-bold text-green-500" id="profitDisplay">+0.00</span>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="placeOrder('long')" class="flex flex-col items-center justify-center bg-[#0ECB81] text-white py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                <span class="text-lg font-bold">Buy Long</span>
                <span class="text-xs opacity-90">Bullish</span>
            </button>
            <button onclick="placeOrder('short')" class="flex flex-col items-center justify-center bg-[#F6465D] text-white py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                <span class="text-lg font-bold">Buy Short</span>
                <span class="text-xs opacity-90">Bearish</span>
            </button>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-2 px-6 flex justify-between items-center z-50 max-w-md mx-auto">
        <a href="index.html" class="flex flex-col items-center bottom-nav-item cursor-pointer">
            <i class="fa-solid fa-house text-xl mb-1"></i>
            <span class="text-[10px]">Home</span>
        </a>
        <a href="quotes.html" class="flex flex-col items-center bottom-nav-item cursor-pointer">
            <i class="fa-solid fa-chart-simple text-xl mb-1"></i>
            <span class="text-[10px]">Quotes</span>
        </a>
        <a href="transaction.html" class="flex flex-col items-center bottom-nav-item cursor-pointer">
            <i class="fa-solid fa-arrow-right-arrow-left text-xl mb-1"></i>
            <span class="text-[10px]">Spot</span>
        </a>
        <a href="futures.html" class="relative -top-5">
            <div class="w-12 h-12 bg-gray-900 rounded-full flex items-center justify-center shadow-lg border-4 border-white">
                <i class="fa-solid fa-file-contract text-white text-lg"></i>
            </div>
            <div class="text-center mt-1">
                <span class="text-[10px] text-gray-900 font-semibold">Futures</span>
            </div>
        </a>
        <a href="assets.html" class="flex flex-col items-center bottom-nav-item cursor-pointer">
            <i class="fa-solid fa-wallet text-xl mb-1"></i>
            <span class="text-[10px]">Assets</span>
        </a>
    </div>

    <!-- Countdown Modal -->
    <div id="countdownModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-sm rounded-2xl p-6 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gray-100">
                <div id="progressBar" class="h-full bg-yellow-400 transition-all duration-1000" style="width: 100%"></div>
            </div>
            
            <h3 class="text-lg font-bold text-gray-800 mb-1" id="cdPair">BTC/USDT</h3>
            <div class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-6" id="cdBadge">LONG</div>

            <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="80" cy="80" r="70" stroke="#f3f4f6" stroke-width="8" fill="none"></circle>
                    <circle id="progressCircle" cx="80" cy="80" r="70" stroke="#FCD535" stroke-width="8" fill="none" stroke-dasharray="440" stroke-dashoffset="0" stroke-linecap="round"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="countdown" class="text-5xl font-bold text-gray-800 font-mono">60</span>
                    <span class="text-xs text-gray-400 uppercase tracking-wider mt-1">Seconds</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-4 rounded-xl mb-4">
                <div class="text-left">
                    <div class="text-gray-400 text-xs">Entry Price</div>
                    <div class="font-bold text-gray-800" id="entryPrice">--</div>
                </div>
                <div class="text-right">
                    <div class="text-gray-400 text-xs">Current Price</div>
                    <div class="font-bold text-gray-800" id="livePrice">--</div>
                </div>
            </div>

            <button onclick="hideModal()" class="text-gray-400 text-sm hover:text-gray-600">Run in Background</button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="hidden fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl transform transition-all scale-100">
            <div id="resIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-lg"></div>
            <h2 id="resTitle" class="text-3xl font-bold mb-2 text-gray-800">Win</h2>
            <div class="text-gray-400 text-sm mb-6">Transaction Result</div>
            <div id="resProfit" class="text-4xl font-bold mb-8 text-green-500 tracking-tight">+0.00</div>
            <button onclick="closeResult()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition-colors">Continue Trading</button>
        </div>
    </div>

    <script src="translations.js"></script>
    <script>
        let currentSymbol = 'BTCUSDT';
        let currentTime = 30;
        let currentProfitPercent = 0.8; // Default 80%
        let timerInterval;
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const s = urlParams.get('symbol');
            if(s) currentSymbol = s.toUpperCase();
            
            document.getElementById('pairTitle').textContent = currentSymbol.replace('USDT', '/USDT');
            
            // Init Chart
            new TradingView.widget({
                "width": "100%",
                "height": 350,
                "symbol": "BINANCE:" + currentSymbol,
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_top_toolbar": true,
                "hide_legend": true,
                "save_image": false,
                "container_id": "tv_chart_container"
            });

            fetchUserData();
            updateProfit();
            
            // Listen for input changes to update profit preview
            document.getElementById('amount').addEventListener('input', updateProfit);
        });

        function selectTime(sec) {
            currentTime = sec;
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            document.getElementById('t' + sec).classList.add('active');
            
            // Adjust profit percent based on time (Mock logic)
            if(sec === 30) currentProfitPercent = 0.3;
            if(sec === 60) currentProfitPercent = 0.5;
            if(sec === 180) currentProfitPercent = 0.8;
            if(sec === 300) currentProfitPercent = 1.0;
            
            updateProfit();
        }

        function updateProfit() {
            const amt = parseFloat(document.getElementById('amount').value) || 0;
            const profit = amt * currentProfitPercent;
            document.getElementById('profitDisplay').textContent = '+' + profit.toFixed(2);
        }

        function fetchUserData() {
            const u = localStorage.getItem('authUser');
            if(!u) return;
            fetch('/api/me', { headers: { 'x-user': u } })
            .then(r=>r.json())
            .then(d=>{
                if(d && d.balance !== undefined) {
                    document.getElementById('userBalance').textContent = d.balance.toFixed(2);
                }
            });
        }

        async function placeOrder(side) {
            const amount = parseFloat(document.getElementById('amount').value);
            if(!amount || amount <= 0) {
                alert("Please enter a valid amount");
                return;
            }

            const u = localStorage.getItem('authUser');
            if(!u) {
                location.href = 'login.html';
                return;
            }

            // Call API
            try {
                const res = await fetch('/api/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: u,
                        symbol: currentSymbol,
                        side: side,
                        amount: amount,
                        seconds: currentTime,
                        percent: currentProfitPercent * 100
                    })
                });
                
                const data = await res.json();
                
                if(data.error) {
                    alert(data.error);
                } else {
                    // Start Countdown UI
                    startCountdown(currentTime, data.result, data.profit, side, amount);
                    fetchUserData(); // Update balance immediately (deducted?)
                    // Note: The backend adds profit immediately if win, or subtracts if lose?
                    // Wait, the backend implementation of api/trade handles the logic immediately.
                    // So the balance is already updated.
                }
            } catch(e) {
                console.error(e);
                alert("Network error");
            }
        }

        function startCountdown(seconds, result, profit, side, amount) {
            const modal = document.getElementById('countdownModal');
            modal.classList.remove('hidden');
            
            const badge = document.getElementById('cdBadge');
            badge.textContent = side.toUpperCase();
            badge.className = `inline-block px-3 py-1 rounded-full text-xs font-bold mb-6 ${side==='long' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`;
            
            let left = seconds;
            const total = seconds;
            const circle = document.getElementById('progressCircle');
            const circumference = 440;
            
            document.getElementById('entryPrice').textContent = '...'; // We don't have real price here easily without fetch
            document.getElementById('livePrice').textContent = '...';

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                left--;
                document.getElementById('countdown').textContent = left;
                
                const offset = circumference - (left / total) * circumference;
                circle.style.strokeDashoffset = offset;
                
                if(left <= 0) {
                    clearInterval(timerInterval);
                    hideModal();
                    showResult(result, profit);
                }
            }, 1000);
        }

        function hideModal() {
            document.getElementById('countdownModal').classList.add('hidden');
        }

        function showResult(result, profit) {
            const modal = document.getElementById('resultModal');
            modal.classList.remove('hidden');
            
            const title = document.getElementById('resTitle');
            const val = document.getElementById('resProfit');
            const icon = document.getElementById('resIcon');
            
            if(result === 'win') {
                title.textContent = "Victory";
                title.className = "text-3xl font-bold mb-2 text-green-500";
                val.textContent = "+" + parseFloat(profit).toFixed(2) + " USDT";
                val.className = "text-4xl font-bold mb-8 text-green-500 tracking-tight";
                icon.innerHTML = '<i class="fa-solid fa-trophy"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-lg bg-green-100 text-green-500";
            } else {
                title.textContent = "Defeat";
                title.className = "text-3xl font-bold mb-2 text-red-500";
                val.textContent = parseFloat(profit).toFixed(2) + " USDT";
                val.className = "text-4xl font-bold mb-8 text-red-500 tracking-tight";
                icon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-lg bg-red-100 text-red-500";
            }
        }

        function closeResult() {
            document.getElementById('resultModal').classList.add('hidden');
            fetchUserData();
        }
    </script>
</body>
</html>